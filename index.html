<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบคืนของเสีย TVS INNO TrueID</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            50% { transform: translateX(0%) translateY(0%) rotate(180deg); }
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .company-logo {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .company-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .nav-bar {
            background: rgba(156, 39, 176, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid #7b1fa2;
        }

        .nav-button {
            background: linear-gradient(135deg, #af52bf 0%, #9c27b0 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            margin: 0 8px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-button:hover::before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        .form-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            margin: 0 auto;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6a1b9a, #8e24aa, #9c27b0, #af52bf);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .form-card h1 {
            text-align: center;
            background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 auto 25px auto;
            font-size: 1.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            display: block;
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
            box-sizing: border-box;
        }



        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .label-icon {
            font-size: 1.2rem;
        }

        .input-container {
            position: relative;
        }

        .form-group input[type="date"],
        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            box-sizing: border-box;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #9c27b0;
            outline: none;
            box-shadow: 0 0 0 4px rgba(156, 39, 176, 0.15);
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            max-height: 200px;
            font-family: 'Segoe UI', monospace;
        }

        .char-counter {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.8rem;
            color: #999;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .submit-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            display: block;
            margin: 25px auto 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 180px;
        }

        .submit-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
        }

        .submit-button:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            margin-bottom: 10px;
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid #4CAF50;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 450px;
            min-width: 320px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            max-width: 100%;
        }

        /* History Page Styles */
        .history-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-container {
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .search-input:focus {
            border-color: #9c27b0;
            outline: none;
            box-shadow: 0 0 0 4px rgba(156, 39, 176, 0.15);
        }

        .filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-filter {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .date-filter:focus {
            border-color: #9c27b0;
            outline: none;
        }

        .clear-filter-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clear-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .history-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            border-radius: 15px;
            border: 1px solid rgba(156, 39, 176, 0.1);
        }

        .history-list-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            background: rgba(248, 249, 255, 0.5);
            margin-bottom: 20px;
        }

        .history-list {
            padding: 10px;
        }

        .history-item {
            background: white;
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #9c27b0;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .history-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .history-date {
            color: #666;
            font-size: 0.9rem;
            background: rgba(156, 39, 176, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .history-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .history-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        .history-sn-preview {
            background: rgba(156, 39, 176, 0.05);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #555;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(156, 39, 176, 0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.4;
        }

        .sn-count-badge {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-subtext {
            font-size: 0.9rem;
            font-style: italic;
        }

        .history-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .refresh-btn,
        .export-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }

        .refresh-btn:hover,
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .export-btn:hover {
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        /* Delete functionality styles */
        .delete-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .delete-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .delete-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .delete-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .delete-modal.show .delete-modal-content {
            transform: scale(1);
        }

        .delete-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f44336;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .delete-modal-message {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .password-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            text-align: center;
            font-family: monospace;
            letter-spacing: 2px;
        }

        .password-input:focus {
            border-color: #f44336;
            outline: none;
            box-shadow: 0 0 0 4px rgba(244, 67, 54, 0.15);
        }

        .delete-modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-delete-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .confirm-delete-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .confirm-delete-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .cancel-delete-btn {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cancel-delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
        }

        /* Pagination styles */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(248, 249, 255, 0.5);
            border-radius: 12px;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .pagination-btn {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .page-numbers {
            display: flex;
            gap: 8px;
        }

        .page-number {
            background: rgba(156, 39, 176, 0.1);
            color: #9c27b0;
            border: 2px solid rgba(156, 39, 176, 0.2);
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 35px;
            text-align: center;
        }

        .page-number:hover {
            background: rgba(156, 39, 176, 0.2);
            transform: translateY(-1px);
        }

        .page-number.active {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            border-color: #9c27b0;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .items-per-page select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .items-per-page select:focus {
            border-color: #9c27b0;
            outline: none;
        }



        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }

            .company-logo {
                font-size: 1.7rem;
            }

            .company-name {
                font-size: 1.3rem;
            }

            .nav-button {
                padding: 8px 16px;
                font-size: 13px;
                margin: 0 4px;
            }

            .container {
                padding: 15px;
                min-height: calc(100vh - 120px);
            }

            .form-card {
                padding: 20px;
                border-radius: 12px;
            }

            .form-card h1 {
                font-size: 1.4rem;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group input,
            .form-group textarea {
                padding: 10px 14px;
                font-size: 14px;
            }

            .form-group textarea {
                min-height: 80px;
            }

            .submit-button {
                padding: 12px 24px;
                font-size: 15px;
                margin: 20px auto 0;
            }

            .history-list-container {
                max-height: 300px;
            }

            .history-item {
                padding: 12px;
                margin-bottom: 10px;
            }

            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                max-width: none;
                min-width: auto;
                width: 100%;
                box-sizing: border-box;
            }
        }

        @media (max-width: 480px) {
            .company-logo {
                font-size: 1.5rem;
                margin-bottom: 6px;
            }

            .company-name {
                font-size: 1.1rem;
            }

            .header-subtitle {
                font-size: 0.8rem;
            }

            .nav-bar {
                padding: 10px 0;
            }

            .nav-button {
                width: calc(100% - 30px);
                margin: 4px auto;
                display: block;
                padding: 10px 20px;
                font-size: 13px;
            }

            .container {
                padding: 10px;
                min-height: calc(100vh - 110px);
            }

            .form-card {
                padding: 16px;
                border-radius: 10px;
            }

            .form-card h1 {
                font-size: 1.2rem;
                margin-bottom: 16px;
            }

            .form-group {
                margin-bottom: 14px;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .submit-button {
                width: 100%;
                max-width: 250px;
                padding: 12px 20px;
                font-size: 14px;
            }

            .history-controls {
                flex-direction: column;
                gap: 12px;
            }

            .search-container {
                min-width: auto;
            }

            .pagination-container {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .page-numbers {
                justify-content: center;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="header">
   <div class="header-content"><span class="company-logo">🏢</span>
    <div class="company-name" id="companyName">
     TVS, INNO, TrueID
    </div>
    <div class="header-subtitle">
     ระบบจัดการคืนของเสีย
    </div>
   </div>
  </div>
  <div class="nav-bar"><button class="nav-button active" id="returnFormBtn"> 📋 คืนของเสียสโตร์บ้านสวน </button> <button class="nav-button" id="historyBtn"> 📊 ประวัติคืนของเสีย </button>
  </div>
  <div class="container"><!-- Form Page -->
   <div class="form-card" id="formPage">
    <h1 id="formTitle">คืนของเสีย TVS,INNO,TrueID</h1>
    <form id="returnForm">
     <div class="form-group"><label for="returnDate"> <span class="label-icon">📅</span> วันที่คืนของเสีย: </label>
      <div class="input-container"><input type="date" id="returnDate" name="returnDate" required>
      </div>
     </div>
     <div class="form-group"><label for="fullName"> <span class="label-icon">👤</span> ชื่อ-นามสกุล ผู้คืน: </label>
      <div class="input-container"><input type="text" id="fullName" name="fullName" placeholder="กรอกชื่อ-นามสกุลของคุณ" required>
      </div>
     </div>
     <div class="form-group"><label for="snList"> <span class="label-icon">📦</span> SN ของเสียที่นำมาคืน: </label>
      <div class="input-container"><textarea id="snList" name="snList" rows="8" placeholder="SN12345
SN67890
SNABCDE
...

กรอก SN แต่ละตัวในบรรทัดใหม่"></textarea>
       <div class="char-counter" id="charCounter">
        0 SN
       </div>
      </div>
     </div><button type="submit" class="submit-button" id="submitBtn">
      <div class="button-content"><span id="buttonText">📤 ส่งข้อมูล</span>
       <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
      </div></button>
    </form>
   </div><!-- History Page -->
   <div class="form-card" id="historyPage" style="display: none;">
    <h1>📊 ประวัติคืนของเสีย</h1>
    <div class="history-controls">
     <div class="search-container"><input type="text" id="searchInput" placeholder="🔍 ค้นหาชื่อ หรือ SN..." class="search-input">
     </div>
     <div class="filter-container"><input type="date" id="dateFilter" class="date-filter"> <button class="clear-filter-btn" id="clearFilterBtn">ล้างตัวกรอง</button>
     </div>
    </div>
    <div class="items-per-page"><span>แสดง:</span> <select id="itemsPerPage"> <option value="5">5 รายการ</option> <option value="10" selected>10 รายการ</option> <option value="20">20 รายการ</option> <option value="50">50 รายการ</option> </select> <span>ต่อหน้า</span>
    </div>
    <div class="history-stats">
     <div class="stat-item"><span class="stat-number" id="historyTotalSubmissions">0</span>
      <div class="stat-label">
       รายการทั้งหมด
      </div>
     </div>
     <div class="stat-item"><span class="stat-number" id="historyTodaySubmissions">0</span>
      <div class="stat-label">
       วันนี้
      </div>
     </div>
     <div class="stat-item"><span class="stat-number" id="historyTotalSN">0</span>
      <div class="stat-label">
       SN ทั้งหมด
      </div>
     </div>
    </div>
    <div class="history-list-container">
     <div class="history-list" id="historyList">
      <div class="empty-history">
       <div class="empty-icon">
        📋
       </div>
       <div class="empty-text">
        ยังไม่มีข้อมูลประวัติ
       </div>
       <div class="empty-subtext">
        ข้อมูลจะแสดงที่นี่หลังจากส่งฟอร์มแล้ว
       </div>
      </div>
     </div>
    </div>
    <div class="pagination-container" id="paginationContainer" style="display: none;"><button class="pagination-btn" id="prevPageBtn"> ⬅️ หน้าก่อน </button>
     <div class="page-numbers" id="pageNumbers"></div><button class="pagination-btn" id="nextPageBtn"> หน้าถัดไป ➡️ </button>
     <div class="pagination-info" id="paginationInfo"></div>
    </div>
    <div class="history-actions"><button class="refresh-btn" id="refreshBtn"> 🔄 รีเฟรชข้อมูล </button> <button class="export-btn" id="exportBtn"> 📥 ส่งออกข้อมูล </button>
    </div>
   </div>
  </div>
  <div class="toast-container" id="toastContainer"></div><!-- Delete Confirmation Modal -->
  <div class="delete-modal" id="deleteModal">
   <div class="delete-modal-content">
    <div class="delete-modal-title">
     🗑️ ยืนยันการลบข้อมูล
    </div>
    <div class="delete-modal-message">
     กรุณาใส่รหัสผ่านเพื่อยืนยันการลบข้อมูลนี้<br><strong>การลบแล้วจะไม่สามารถกู้คืนได้</strong>
    </div><input type="password" id="deletePassword" class="password-input" placeholder="ใส่รหัสผ่าน" maxlength="20">
    <div class="delete-modal-actions"><button class="cancel-delete-btn" id="cancelDeleteBtn">ยกเลิก</button> <button class="confirm-delete-btn" id="confirmDeleteBtn" disabled>ลบข้อมูล</button>
    </div>
   </div>
  </div>
 <script>
    // Helper function for getting SN lines
    const getSNLines = (snList) => snList.split('\n').filter(line => line.trim() !== '');

    // Default configuration (ใช้ GAS URL เดียวกันสำหรับส่งและดึงข้อมูล)
    const defaultConfig = {
        company_name: "TVS, INNO, TrueID",
        form_title: "คืนของเสีย TVS,INNO,TrueID",
        success_message: "ข้อมูลถูกส่งสำเร็จแล้ว!",
        gas_url: "https://script.google.com/macros/s/AKfycbytBdfoJP1o8Kvfse53O-jYQakpMyW7w3G_HaDCjGBmcmqpRIAmq-GLbj2j_07mGBqdHA/exec" 
    };

    // Global variables
    let isLoading = false;
    let currentPage = 'form';
    let historyData = [];
    let filteredData = [];
    let currentHistoryPage = 1;
    let itemsPerPage = 10;
    let itemToDelete = null;
    const DELETE_PASSWORD = 'John19195';

    // ==========================================================
    // 💡 NEW DATE FORMATTING FUNCTIONS
    // ==========================================================

    /**
     * แปลง ISO date string เป็นรูปแบบ DD/MM/YYYY
     * ใช้สำหรับฟิลด์ วันที่คืน (Return Date)
     */
    function formatISODateToDDMMYYYY(isoString) {
        if (!isoString) return '';
        try {
            // New Date() object handles the ISO string, ensuring timezone correctness
            const dateObj = new Date(isoString);
            
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${day}/${month}/${year}`;
        } catch (e) {
            // Fallback: หากแปลงไม่ได้ ให้แสดงเฉพาะส่วนวันที่ YYYY-MM-DD
            return isoString.split('T')[0] || isoString;
        }
    }

    /**
     * แปลง ISO date string เป็นรูปแบบ DD/MM/YYYY, HH:mm:ss
     * ใช้สำหรับฟิลด์ วันที่และเวลาส่ง (Submitted At)
     */
    function formatISODateTime(isoString) {
        if (!isoString) return '';
        try {
            const dateObj = new Date(isoString);
            
            const datePart = formatISODateToDDMMYYYY(isoString); 
            
            const hours = String(dateObj.getHours()).padStart(2, '0');
            const minutes = String(dateObj.getMinutes()).padStart(2, '0');
            const seconds = String(dateObj.getSeconds()).padStart(2, '0');
            
            return `${datePart}, ${hours}:${minutes}:${seconds}`;
        } catch (e) {
            return isoString;
        }
    }

    // ==========================================================
    // END OF NEW DATE FORMATTING FUNCTIONS
    // ==========================================================

    // Initialize SDKs (ส่วนนี้ใช้สำหรับระบบ Element)
    async function initializeApp() {
        if (window.elementSdk) {
            await window.elementSdk.init({
                defaultConfig,
                render: async (config) => {
                    document.getElementById('companyName').textContent = config.company_name || defaultConfig.company_name;
                    document.getElementById('formTitle').textContent = config.form_title || defaultConfig.form_title;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["company_name", config.company_name || defaultConfig.company_name],
                    ["form_title", config.form_title || defaultConfig.form_title],
                    ["success_message", config.success_message || defaultConfig.success_message],
                    ["gas_url", config.gas_url || defaultConfig.gas_url]
                ])
            });
        }
    }

    function setCurrentDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('returnDate').value = `${year}-${month}-${day}`;
    }

    function updateCharCounter() {
        const textarea = document.getElementById('snList');
        const counter = document.getElementById('charCounter');
        const lines = getSNLines(textarea.value);
        counter.textContent = `${lines.length} SN`;
    }

    function showToast(message, type = 'success', title = '') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' ? '✅' : '❌';
        const toastTitle = title || (type === 'success' ? 'สำเร็จ' : 'เกิดข้อผิดพลาด');
        
        toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-content">
                <div class="toast-title">${toastTitle}</div>
                <div class="toast-message">${message}</div>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 4000);
    }

    function setLoadingState(loading) {
        isLoading = loading;
        const submitBtn = document.getElementById('submitBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        if (loading) {
            submitBtn.disabled = true;
            buttonText.textContent = 'กำลังส่งข้อมูล...';
            loadingSpinner.style.display = 'block';
        } else {
            submitBtn.disabled = false;
            buttonText.textContent = '📤 ส่งข้อมูล';
            loadingSpinner.style.display = 'none';
        }
    }

    // Handle form submission
    async function handleSubmit(e) {
        e.preventDefault();
        
        if (isLoading) return;
        
        setLoadingState(true);
        
        const config = window.elementSdk?.config || defaultConfig;
        const gasUrl = config.gas_url || defaultConfig.gas_url;
        
        const formData = new FormData();
        formData.append('action', 'submit'); // **เพิ่ม:** บอก GAS ว่าเป็นการส่งข้อมูล
        formData.append('returnDate', document.getElementById('returnDate').value);
        formData.append('fullName', document.getElementById('fullName').value);
        formData.append('snList', document.getElementById('snList').value);
        
        try {
            const response = await fetch(gasUrl, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'SUCCESS') {
                const successMessage = config.success_message || defaultConfig.success_message;
                showToast(successMessage, "success");
                
                document.getElementById('returnForm').reset();
                setCurrentDate();
                updateCharCounter();
                
                if (currentPage === 'history') {
                    await loadHistoryData();
                }

            } else {
                 showToast(`เกิดข้อผิดพลาดในการบันทึก: ${result.message || 'กรุณาตรวจสอบ GAS Script'}`, "error");
            }

        } catch (error) {
            console.error('Error submitting form:', error);
            showToast("เกิดข้อผิดพลาดในการส่งข้อมูล กรุณาตรวจสอบ URL หรือการตั้งค่า CORS", "error");
        }
        
        setLoadingState(false);
    }

    // Page navigation
    function showPage(page) {
        currentPage = page;
        
        document.getElementById('formPage').style.display = 'none';
        document.getElementById('historyPage').style.display = 'none';
        
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (page === 'form') {
            document.getElementById('formPage').style.display = 'block';
            document.getElementById('returnFormBtn').classList.add('active');
        } else if (page === 'history') {
            document.getElementById('historyPage').style.display = 'block';
            document.getElementById('historyBtn').classList.add('active');
            loadHistoryData(); 
        }
    }

    async function loadHistoryData() {
        const config = window.elementSdk?.config || defaultConfig;
        const gasUrl = config.gas_url || defaultConfig.gas_url;
        const refreshBtn = document.getElementById('refreshBtn');

        refreshBtn.innerHTML = '🔄 กำลังโหลด...';
        refreshBtn.disabled = true;

        const fetchUrl = `${gasUrl}?action=read`; 
        
        try {
            const response = await fetch(fetchUrl);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const result = await response.json();

            if (result && Array.isArray(result.data)) {
                historyData = result.data.reverse(); 
                filterHistory(false); 
                showToast("โหลดข้อมูลประวัติสำเร็จ", "success", "อัปเดตข้อมูล");
            } else {
                historyData = [];
                filterHistory(false);
                showToast("ไม่พบข้อมูลประวัติ หรือ GAS ส่งข้อมูลผิดพลาด", "error");
            }
        } catch (error) {
            console.error('Error fetching history:', error);
            historyData = [];
            filterHistory(false);
            showToast("เกิดข้อผิดพลาดในการโหลดประวัติจาก GAS", "error");
        } finally {
            refreshBtn.innerHTML = '🔄 รีเฟรชข้อมูล';
            refreshBtn.disabled = false;
        }
    }

    function updateHistoryStats() {
        const today = new Date().toISOString().split('T')[0];
        const todaySubmissions = filteredData.filter(item => 
            // ใช้ item.returnDate.split('T')[0] เพื่อเทียบเฉพาะวันที่ YYYY-MM-DD
            (item.returnDate.split('T')[0] === today)
        ).length;

        const totalSN = filteredData.reduce((total, item) => {
            return total + getSNLines(item.snList).length;
        }, 0);

        document.getElementById('historyTotalSubmissions').textContent = filteredData.length;
        document.getElementById('historyTodaySubmissions').textContent = todaySubmissions;
        document.getElementById('historyTotalSN').textContent = totalSN;
    }

    function renderHistoryList() {
        const historyList = document.getElementById('historyList');
        const paginationContainer = document.getElementById('paginationContainer');
        
        if (filteredData.length === 0) {
            historyList.innerHTML = `
                <div class="empty-history">
                    <div class="empty-icon">📋</div>
                    <div class="empty-text">ไม่พบข้อมูลประวัติ</div>
                    <div class="empty-subtext">ลองปรับเปลี่ยนตัวกรองหรือค้นหาใหม่</div>
                </div>
            `;
            paginationContainer.style.display = 'none';
            return;
        }

        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const startIndex = (currentHistoryPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageData = filteredData.slice(startIndex, endIndex);

        historyList.innerHTML = currentPageData.map(item => {
            const snLines = getSNLines(item.snList);
            
            // **ใช้ฟังก์ชันใหม่สำหรับ วันที่และเวลาที่ส่ง**
            const submittedDateStr = item.submittedAt instanceof Date ? item.submittedAt.toISOString() : item.submittedAt;
            const formattedSubmittedDateTime = formatISODateTime(submittedDateStr);

            // **ใช้ฟังก์ชันใหม่สำหรับ วันที่คืน**
            const formattedReturnDate = formatISODateToDDMMYYYY(item.returnDate);
            
            const snPreview = snLines.join('\n');

            return `
                <div class="history-item">
                    <button class="delete-btn" onclick="showDeleteModal('${item.id}')">
                        🗑️ ลบ
                    </button>
                    <div class="history-header-info">
                        <div class="history-name">${item.fullName}</div>
                        <div class="history-date">${formattedSubmittedDateTime}</div> 
                    </div>
                    <div class="history-details">
                        <div class="history-detail-item">
                            <span>📅</span>
                            <span>วันที่คืน: ${formattedReturnDate}</span> 
                        </div>
                        <div class="history-detail-item">
                            <span>📦</span>
                            <span class="sn-count-badge">${snLines.length} SN</span>
                        </div>
                    </div>
                    <div class="history-sn-preview">${snPreview}</div>
                </div>
            `;
        }).join('');

        if (totalPages > 1) {
            paginationContainer.style.display = 'flex';
            renderPagination(totalPages);
        } else {
            paginationContainer.style.display = 'none';
        }
    }

    function renderPagination(totalPages) {
        const pageNumbers = document.getElementById('pageNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');

        const startItem = (currentHistoryPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentHistoryPage * itemsPerPage, filteredData.length);
        paginationInfo.textContent = `${startItem}-${endItem} จาก ${filteredData.length} รายการ`;

        prevBtn.disabled = currentHistoryPage === 1;
        nextBtn.disabled = currentHistoryPage === totalPages;

        let pages = [];
        const maxVisiblePages = 5;
        
        if (totalPages <= maxVisiblePages) {
            pages = Array.from({length: totalPages}, (_, i) => i + 1);
        } else {
            const start = Math.max(1, currentHistoryPage - 2);
            const end = Math.min(totalPages, start + maxVisiblePages - 1);
            pages = Array.from({length: end - start + 1}, (_, i) => start + i);
        }

        pageNumbers.innerHTML = pages.map(page => `
            <div class="page-number ${page === currentHistoryPage ? 'active' : ''}" 
                 onclick="goToPage(${page})">
                ${page}
            </div>
        `).join('');
    }

    function goToPage(page) {
        currentHistoryPage = page;
        renderHistoryList();
    }

    function goToPrevPage() {
        if (currentHistoryPage > 1) {
            currentHistoryPage--;
            renderHistoryList();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (currentHistoryPage < totalPages) {
            currentHistoryPage++;
            renderHistoryList();
        }
    }

    function changeItemsPerPage() {
        itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
        currentHistoryPage = 1; 
        renderHistoryList();
    }

    function showDeleteModal(itemId) {
        itemToDelete = itemId;
        const modal = document.getElementById('deleteModal');
        const passwordInput = document.getElementById('deletePassword');
        
        passwordInput.value = '';
        document.getElementById('confirmDeleteBtn').disabled = true;
        
        modal.classList.add('show');
        setTimeout(() => passwordInput.focus(), 300);
    }

    function hideDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('show');
        itemToDelete = null;
        document.getElementById('deletePassword').value = '';
    }

    function checkDeletePassword() {
        const password = document.getElementById('deletePassword').value;
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        confirmBtn.disabled = password !== DELETE_PASSWORD;
    }

    async function confirmDelete() {
        if (!itemToDelete) return;
        
        const password = document.getElementById('deletePassword').value;
        if (password !== DELETE_PASSWORD) {
            showToast('รหัสผ่านไม่ถูกต้อง', 'error');
            return;
        }

        const config = window.elementSdk?.config || defaultConfig;
        const gasUrl = config.gas_url || defaultConfig.gas_url;

        try {
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('id', itemToDelete);

            const response = await fetch(gasUrl, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'SUCCESS') {
                hideDeleteModal();
                showToast('ลบข้อมูลเรียบร้อยแล้ว', 'success');
                await loadHistoryData(); 
            } else {
                showToast(`เกิดข้อผิดพลาดในการลบ: ${result.message || 'กรุณาตรวจสอบ GAS Script'}`, 'error');
            }
            
        } catch (error) {
            console.error('Error deleting item:', error);
            showToast('เกิดข้อผิดพลาดในการลบข้อมูล (Network Error)', 'error');
        }
    }

    // Filter and search functions
    function filterHistory(resetPage = true) {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const dateFilter = document.getElementById('dateFilter').value;
        
        filteredData = historyData.filter(item => {
            const matchesSearch = !searchTerm || 
                item.fullName.toLowerCase().includes(searchTerm) ||
                item.snList.toLowerCase().includes(searchTerm);
            
            // ใช้ .split('T')[0] เพื่อให้เทียบกับ input type="date" ได้ถูกต้อง
            const matchesDate = !dateFilter || item.returnDate.split('T')[0] === dateFilter; 
            
            return matchesSearch && matchesDate;
        });
        
        if (resetPage) {
            currentHistoryPage = 1;
        }
        
        updateHistoryStats();
        renderHistoryList();
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFilter').value = '';
        filterHistory();
    }

    // Export data to CSV
    function exportData() {
        if (filteredData.length === 0) {
            showToast("ไม่มีข้อมูลให้ส่งออก", "error");
            return;
        }

        const csvContent = [
            // อัปเดต Header ให้สอดคล้องกับการเปลี่ยนแปลงวันที่
            ['วันที่และเวลาส่ง', 'วันที่คืน', 'ชื่อ-นามสกุล', 'จำนวน SN', 'รายการ SN'],
            ...filteredData.map(item => {
                const snLines = getSNLines(item.snList);
                
                // ใช้ฟังก์ชันใหม่ในการจัดรูปแบบ
                const submittedDateTime = formatISODateTime(item.submittedAt instanceof Date ? item.submittedAt.toISOString() : item.submittedAt);
                const returnDate = formatISODateToDDMMYYYY(item.returnDate);
                
                return [
                    submittedDateTime, // ใช้รูปแบบใหม่
                    returnDate, // ใช้รูปแบบใหม่
                    item.fullName,
                    snLines.length,
                    snLines.join('; ')
                ];
            })
        ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `ประวัติคืนของเสีย_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast("ส่งออกข้อมูลเรียบร้อยแล้ว", "success");
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        setCurrentDate();
        
        document.getElementById('returnForm').addEventListener('submit', handleSubmit);
        document.getElementById('snList').addEventListener('input', updateCharCounter);
        
        document.getElementById('returnFormBtn').addEventListener('click', () => showPage('form'));
        document.getElementById('historyBtn').addEventListener('click', () => showPage('history'));
        
        document.getElementById('searchInput').addEventListener('input', filterHistory);
        document.getElementById('dateFilter').addEventListener('change', filterHistory);
        document.getElementById('clearFilterBtn').addEventListener('click', clearFilters);
        document.getElementById('refreshBtn').addEventListener('click', loadHistoryData); 
        document.getElementById('exportBtn').addEventListener('click', exportData);
        
        document.getElementById('itemsPerPage').addEventListener('change', changeItemsPerPage);
        document.getElementById('prevPageBtn').addEventListener('click', goToPrevPage);
        document.getElementById('nextPageBtn').addEventListener('click', goToNextPage);
        
        document.getElementById('deletePassword').addEventListener('input', checkDeletePassword);
        document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideDeleteModal();
            }
        });
        
        document.getElementById('deletePassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('confirmDeleteBtn').disabled) {
                confirmDelete();
            }
        });
        
        updateCharCounter();
    });
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992f62bc500d4b71',t:'MTc2MTIwMzEyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
